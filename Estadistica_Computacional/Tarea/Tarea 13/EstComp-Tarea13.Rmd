---
title: "EstComp-Tarea13"
author: "Gabriela Itzel Vargas Chac?n"
output: html_document
date: "2 de diciembre de 2018"
---

## 13-Modelos jerárquicos {-}

En este ejercicio definirás un modelo jerárquico para la incidencia de tumores
en grupos de conejos a los que se suministró una medicina. Se realizaron 71
experimentos distintos utilizando la misma medicina. 

Considerando que cada conejo proviene de un experimento distinto, se desea
estudiar $\theta_j$, la probabilidad de desarrollar un tumor en el 
$j$-ésimo grupo, este parámetro variará de grupo a grupo.

Denotaremos $y_{ij}$ la observación en el $i$-ésimo conejo perteneciente al 
$j$-ésimo experimento, $y_{ij}$ puede tomar dos valores: 1 indicando que el 
conejo desarrolló tumor y 0 en el caso contrario, por tanto la verosimilitud 
sería:

$$y_{ij} \sim Bernoulli(\theta_j)$$

Adicionalmente se desea estimar el efecto medio de la medicina a lo largo de
los grupos $\mu$, por lo que utilizaremos un modelo jerárquico como sigue:

$$\theta_j \sim Beta(a, b)$$

donde 

$$a=\mu \kappa$$
$$b=(1-\mu)\kappa$$

Finalmente asignamos una distribución a los hiperparámetros $\mu$ y $\kappa$,

$$\mu \sim Beta(A_{\mu}, B_{\mu})$$

$$\kappa \sim Gamma(S_{\kappa}, R_{\kappa})$$

1. Si piensas en este problema como un lanzamiento de monedas, ¿a qué 
corresponden las monedas y los lanzamientos?

$\theta_j \sim Beta(a, b)$ corresponde a las monedas.
$y_{ij} \sim Bernoulli(\theta_j)$ corresponde a los lanzamientos.



2. Los datos en el archivo `rabbits.RData` contienen las observaciones de los 
71 experimentos, 
cada renglón corresponde a una observación. 
    + Utiliza JAGS o Stan para ajustar un modelo jerárquico como el descrito 
    arriba y usando una inicial $Beta(1, 1)$ y una $Gamma(1, 0.1)$ para $\mu$ y
    $\kappa$ respectivamente. 
    + Realiza un histograma de la distribución posterior de $\mu$, $\kappa$. 
    Comenta tus resultados.

```{r, echo = FALSE, message = FALSE}
library(tidyverse)
library(ggplot2)
library(R2jags)
library(readr)
```
    
```{r}
```

```{r}
modelo_jer.rabbits <-
'
model{
  for(t in 1:N){
    x[t] ~ dbern(theta[coin[t]])
  }
  for(j in 1:nCoins){
    theta[j] ~ dbeta(a, b)
  }
  a <- mu * kappa
  b <- (1 - mu) * kappa
  # A_mu = 1, B_mu = 1
  mu ~ dbeta(1, 1)
  kappa ~ dgamma(1, 0.1)
}
'
cat(modelo_jer.rabbits, file = 'modelo_jer.rabbits')
x<-rabbits[,"tumor"]
coin<-rabbits[,"experiment"]

jags.inits <- function(){
  list("mu" = runif(1, 0.1, 0.9),
    "kappa" = runif(1, 5, 20))
}

jags_fit <- jags(
  model.file = "modelo_jer.rabbits",    # modelo de JAGS
  inits = jags.inits,   # valores iniciales
  data = list(x = x, coin = coin, nCoins = max(coin),  N = length(x)),    # lista con los datos
  parameters.to.save = c("mu", "kappa", "theta"),  # par?metros por guardar
  n.chains = 3,   # n?mero de cadenas
  n.iter = 10000,    # n?mero de pasos
  n.burnin = 1000   # calentamiento de la cadena
  )

jags_fit
```
```{r}
sims_df <- data.frame(n_sim = 1:jags_fit$BUGSoutput$n.sims,
  jags_fit$BUGSoutput$sims.matrix) %>% 
  dplyr::select(-deviance) %>%
  gather(parametro, value, -n_sim)

ggplot(filter(sims_df, parametro == "kappa"), aes(x = value)) +
  geom_histogram(alpha = 0.8) + labs(title = "Distribuci?n posterior de Kappa")
ggplot(filter(sims_df, parametro == "mu"), aes(x = value)) +
  geom_histogram(alpha = 0.8) + labs(title = "Distribuci?n posterior de Mu")
```


3. Ajusta un nuevo modelo utilizando una iniciales $Beta(10, 10)$ y 
$Gamma(0.51, 0.01)$ para $\mu$ y $\kappa$ (lo demás quedará igual). 
    + Realiza una gráfica con las medias posteriores de los parámetros 
    $\theta_j$ bajo los dos escenarios de distribuciones iniciales: en el eje 
    horizontal grafica las medias posteriores del modelo ajustado en el paso
    anterior y en el eje vertical las medias posteriores del segundo modelo . 
    ¿Cómo se comparan? ¿A qué se deben las diferencias?
    
```{r}
modelo_jer.rabbits2 <-
'
model{
  for(t in 1:N){
    x[t] ~ dbern(theta[coin[t]])
  }
  for(j in 1:nCoins){
    theta[j] ~ dbeta(a, b)
  }
  a <- mu * kappa
  b <- (1 - mu) * kappa
  # A_mu = 10, B_mu = 10
  mu ~ dbeta(10, 10)
  kappa ~ dgamma(.51, 0.1)
}
'
cat(modelo_jer.rabbits2, file = 'modelo_jer.rabbits2')

jags.inits <- function(){
  list("mu" = runif(1, 0.1, 0.9),
    "kappa" = runif(1, 5, 20))
}

jags_fit <- jags(
  model.file = "modelo_jer.rabbits2",    # modelo de JAGS
  inits = jags.inits,   # valores iniciales
  data = list(x = x, coin = coin, nCoins = max(coin),  N = length(x)),    # lista con los datos
  parameters.to.save = c("theta"),  # par?metros por guardar
  n.chains = 3,   # n?mero de cadenas
  n.iter = 10000,    # n?mero de pasos
  n.burnin = 1000   # calentamiento de la cadena
  )

sims_df2 <- data.frame(n_sim = 1:jags_fit$BUGSoutput$n.sims,
  jags_fit$BUGSoutput$sims.matrix) %>% 
  dplyr::select(-deviance) %>%
  gather(parametro, value, -n_sim)

sims_df<-sims_df %>% filter(grepl('theta', parametro))

ggplot()+ geom_point(mapping=aes(x=sims_df$value, y=sims_df2$value))
```
